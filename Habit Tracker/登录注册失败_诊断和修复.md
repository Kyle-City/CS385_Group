# 登录注册失败问题诊断和修复

## 🔍 问题原因

登录和注册失败通常由以下几个原因导致：

### 1. ✅ 已修复：后端服务器监听地址问题

**问题**：后端服务器默认只监听 `localhost`，无法从外部 IP 访问。

**修复**：已修改 `backend/server.js`，现在服务器监听 `0.0.0.0`，可以从网络访问。

**需要操作**：重启后端服务器

### 2. 后端服务器未运行

**检查方法**：
```powershell
# 检查端口 3000 是否被占用
netstat -ano | findstr :3000
```

**启动后端**：
```powershell
cd "D:\CS385 Final Project\CS385_Group\Habit Tracker\backend"
npm run dev
```

应该看到：
```
MongoDB connected
Server running on port 3000
Server accessible at http://localhost:3000
Server accessible from network at http://<your-ip>:3000
```

### 3. MongoDB 连接问题

**检查方法**：查看后端服务器日志，如果看到 "MongoDB connection error"，说明数据库连接失败。

**解决方案**：
- 如果使用 MongoDB Atlas，确保：
  - IP 白名单包含你的 IP 地址（或使用 `0.0.0.0/0` 允许所有 IP）
  - 用户名和密码正确
- 如果使用本地 MongoDB，确保服务正在运行

### 4. API 地址配置不匹配

**当前配置**：
- 前端 API 地址：`http://10.132.100.124:3000`

**检查你的 IP 地址**：
```powershell
ipconfig
```
查找 "IPv4 地址"，确保与前端配置一致。

**如果 IP 地址已更改**，需要更新以下文件：
- `frontend/context/AuthContext.js` - 第 5 行
- `frontend/services/api.js` - 第 4 行

### 5. 防火墙阻止连接

**Windows 防火墙可能阻止了端口 3000**

**临时测试**：关闭防火墙测试（不推荐长期使用）

**永久解决**：添加防火墙规则允许端口 3000：
```powershell
# 以管理员身份运行 PowerShell
New-NetFirewallRule -DisplayName "Node.js Server" -Direction Inbound -LocalPort 3000 -Protocol TCP -Action Allow
```

### 6. 网络问题

- 确保手机和电脑连接到**同一个 Wi-Fi 网络**
- 如果使用公司/学校网络，可能需要配置 VPN
- 某些公共 Wi-Fi 可能阻止设备间通信

## 🔧 完整修复步骤

### 步骤 1: 重启后端服务器

```powershell
# 停止当前服务器（如果正在运行）
# 按 Ctrl+C 停止

# 重新启动
cd "D:\CS385 Final Project\CS385_Group\Habit Tracker\backend"
npm run dev
```

### 步骤 2: 验证后端服务器运行

在浏览器中访问：
```
http://localhost:3000/auth/me
```

应该返回错误（因为未认证），但说明服务器在运行。

### 步骤 3: 验证网络访问

在浏览器中访问（使用你的 IP 地址）：
```
http://10.132.100.124:3000/auth/me
```

如果也能访问，说明网络配置正确。

### 步骤 4: 检查前端配置

确认以下文件中的 API 地址正确：
- `frontend/context/AuthContext.js` - 应该是 `http://10.132.100.124:3000`
- `frontend/services/api.js` - 应该是 `http://10.132.100.124:3000`

### 步骤 5: 重启前端应用

```powershell
# 在 Expo 终端中按 'r' 重新加载
# 或完全重启
cd "D:\CS385 Final Project\CS385_Group\Habit Tracker\frontend"
npm start
```

### 步骤 6: 测试注册/登录

1. 在手机上打开 Expo Go
2. 扫描二维码
3. 尝试注册新账户
4. 如果注册成功，尝试登录

## 🐛 常见错误信息

### "Network Error" 或 "无法连接到服务器"
- 后端服务器未运行
- API 地址配置错误
- 防火墙阻止连接
- 网络问题

### "Invalid email or password"
- 密码错误（登录时）
- 用户不存在（登录时）
- 这表示服务器连接正常，但认证失败

### "Email already exists"
- 该邮箱已注册
- 尝试使用其他邮箱或直接登录

### "Server error"
- 查看后端服务器日志
- 可能是 MongoDB 连接问题
- 可能是服务器代码错误

## 📊 诊断检查清单

- [ ] 后端服务器正在运行（端口 3000）
- [ ] MongoDB 连接成功（查看服务器日志）
- [ ] 后端服务器监听 `0.0.0.0`（已修复）
- [ ] 前端 API 地址配置正确
- [ ] 手机和电脑在同一网络
- [ ] 防火墙允许端口 3000
- [ ] 可以访问 `http://10.132.100.124:3000/auth/me`

## 🎯 快速测试命令

### 测试后端 API（PowerShell）

```powershell
# 测试服务器是否运行
Invoke-WebRequest -Uri http://localhost:3000/auth/me

# 测试注册
$body = @{
    email = "test@example.com"
    password = "123456"
    username = "testuser"
} | ConvertTo-Json

Invoke-WebRequest -Uri http://localhost:3000/auth/register -Method POST -Body $body -ContentType "application/json"
```

如果这些命令成功，说明后端服务器工作正常，问题可能在前端配置或网络连接。

## 💡 提示

1. **查看后端日志**：启动后端时，所有错误信息都会显示在终端中
2. **查看前端日志**：在 Expo Go 中，可以摇动手机打开开发者菜单，查看错误信息
3. **使用浏览器测试**：先用浏览器测试 API，确认后端工作正常
4. **检查网络**：确保手机和电脑在同一 Wi-Fi，且防火墙允许连接





